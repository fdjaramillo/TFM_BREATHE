---
title: "Findings Report"
output: word_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(gtsummary)
library(corrplot)
library(ggpubr) # Para stat_cor
```


```{r load_and_impute_data, echo=FALSE}
# Definimos la ruta
processed_data_path <- "../01_data_processed/v2.0"
master_dataset <- readRDS(file.path(processed_data_path, "master_dataset.rds"))

master_dataset <- master_dataset |> 
  select(!c(pack_year, pct_pred_fvc, treatment, diagnosis))

# Imputación (se asume que VIM está cargado si se ejecuta de forma aislada)
imputed_data <- VIM::kNN(master_dataset, k = 3, imp_var = FALSE)
```

# Descriptiva

Tabla descriptiva con las características principales de la cohorte de estudio.

```{r summary_table_1, echo=FALSE}
imputed_data |>
  select(
    age, sex, bmi, smoker, exac_last_year_n, age_diagnosis,
    allergic_rhinitis, crs_w_np,
    snot22, act, tai10, feno_mean, 
    eosinophils_n, eosinophils_pct, ige_total, 
    fev1, fvc, fev1_fvc, 
    is_on_biologic
  ) |>
  tbl_summary(
    label = list(
      age ~ "Edad (años)", sex ~ "Sexo", bmi ~ "IMC (kg/m²)",
      smoker ~ "Estado de Fumador", age_diagnosis ~ "Edad de diagnóstico del asma (años)",
      crs_w_np ~ "Pólipos Nasales (CRSwNP)", allergic_rhinitis ~ "Rinitis Alérgica",
      exac_last_year_n ~ "Nº Exacerbaciones (año previo)", snot22 ~ "SNOT-22",
      act ~ "ACT", feno_mean ~ "FeNO basal (ppb)", eosinophils_n ~ "Eosinófilos (n)",
      eosinophils_pct ~ "Eosinófilos (%)", ige_total ~ "IgE total (kU/L)",
      fev1 ~ "FEV1 (L)", fvc ~ "FVC (L)", fev1_fvc ~ "FEV1/FVC",
      is_on_biologic ~ "En tratamiento biológico"
    ),
    type = list(
      exac_last_year_n ~ "continuous", crs_w_np ~ "categorical",
      allergic_rhinitis ~ "categorical"
    ),
  ) |>
  bold_labels()

```

# Correlación General

```{r plot_correlation, fig.width=12, fig.height=9}
numeric_vars <- imputed_data |>
  select(where(is.numeric))

corr_matrix <- cor(numeric_vars, method = "spearman", use = "complete.obs")

corrplot::corrplot(corr_matrix, method = "color", type = "upper", order = "hclust",
                   addCoef.col = "black", tl.col = "black", tl.srt = 45, number.cex = 0.7)
```
**Observación:** La correlación entre `feno` y `eosinophils` en la cohorte general es positiva pero débil (R=0.34). Otros factores podrían estar modulando su relación.

# Correlación entre Biomarcadores T2

Para investigar qué factor podría explicar la débil correlación, se estratificó el análisis por la presencia de pólipos nasales (CRSwNP).

```{r scatter_feno_eos_by_polyps}
# Scatter plot de FeNO vs Eosinófilos, estratificado por CRSwNP
ggplot(imputed_data, aes(x = eosinophils_n, y = feno_mean)) +
  geom_point(size = 3, alpha = 0.7, aes(colour = crs_w_np)) +
  facet_wrap(
    ~ crs_w_np,
    labeller = "label_both"
  ) +
  labs(title = "crs_w_np", x = "Eosinófilos", y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_cor(method = "spearman")
```

El análisis estratificado revela un claro efecto de interacción. En el subgrupo de pacientes **sin pólipos**, se observa una correlación fuerte y estadísticamente significativa entre el FeNO y los eosinófilos (R=0.56, p<0.001). En el grupo de pacientes **con pólipos**, en cambio, esta correlación desaparece por completo (R=0.15, p=0.49).

# El Efecto del Tratamiento Biológico

Análisis similar para evaluar el impacto del tratamiento biológico sobre esta misma relación.

```{r scatter_feno_eos_by_biologic}
# Scatter plot de FeNO vs Eosinófilos, estratificado por tratamiento biológico
ggplot(imputed_data, aes(x = eosinophils_n, y = feno_mean)) +
  geom_point(size = 3, alpha = 0.7, aes(colour = is_on_biologic)) +
  facet_wrap(
    ~ is_on_biologic,
    labeller = "label_both"
  ) +
  labs(title = "biologic", x = "Eosinófilos", y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_cor(method = "spearman")
```

Se observa un efecto similar. En los pacientes que no reciben terapia biológica, la correlación FeNO-eosinófilos se mantiene de forma significativa (R=0.47, p<0.01). No obstante, en el grupo de pacientes tratados, la correlación se desvanece (R=0.058, p=0.79), lo que demuestra que el tratamiento anula la correlación estadística entre ambos marcadores de inflamación T2.


# Anexo: otros gráficos


## FeNO y age at diagnosis
```{r echo=FALSE, fig.height=4}
ggplot(imputed_data, aes(x = age_diagnosis, y = feno_mean)) +
  geom_point(size = 3, alpha = 0.7, aes(colour = crs_w_np)) +
  facet_wrap(
    ~ crs_w_np,
    labeller = "label_both"
    ) +
  labs(x = "Edad de Diagnóstico del Asma (años)",
       y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_cor(method = "spearman")
```

## FeNO y tai10
```{r echo=FALSE, fig.height=8}
p1 <- ggplot(imputed_data, aes(x = tai10, y = feno_mean)) +
  geom_point(size = 3, alpha = 0.7, aes(colour = crs_w_np)) +
  facet_wrap(
    ~ crs_w_np,
    labeller = "label_both"
    ) +
  labs(title = "Relación entre FeNO y TAI-10",
       x = "TAI-10",
       y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_cor(method = "spearman")

p2 <- ggplot(imputed_data, aes(x = tai10, y = feno_mean)) +
  geom_point(size = 3, alpha = 0.7, aes(colour = is_on_biologic)) +
  facet_wrap(
    ~ is_on_biologic,
    labeller = "label_both"
    ) +
  labs(title = "Relación entre FeNO y TAI-10",
       x = "TAI-10",
       y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_cor(method = "spearman")

cowplot::plot_grid(p1, p2, ncol = 2)
```


## FeNO y eosinófilos por crs_w_np y tratamiento biológico
```{r plot_feno_relations, echo=FALSE, fig.height=8}
# Boxplot de FeNO por CRSwNP
p1 <- ggplot(imputed_data, aes(x = crs_w_np, y = feno_mean, fill = crs_w_np)) +
  geom_boxplot() +
  labs(title = "FeNO por CRSwNP", x = "CRSwNP", y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_compare_means(method = "wilcox.test")

# Boxplot de FeNO por presencia de biológicos
p2 <- ggplot(imputed_data, aes(x = is_on_biologic, y = feno_mean, fill = is_on_biologic)) +
  geom_boxplot() +
  labs(title = "FeNO por Tratamiento Biológico", x = "En Tratamiento Biológico", y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_compare_means()

p3 <- ggplot(imputed_data, aes(x = crs_w_np, y = eosinophils_n, fill = crs_w_np)) +
  geom_boxplot() +
  labs(title = "Eosinófilos por CRSwNP", x = "CRSwNP", y = "Eosinófilos (n)") +
  theme(legend.position = "none") +
  stat_compare_means()

# Boxplot de Eosinófilos por presencia de biológicos
p4 <- ggplot(imputed_data, aes(x = is_on_biologic, y = eosinophils_n, fill = is_on_biologic)) +
  geom_boxplot() +
  labs(title = "Eosinófilos por Tratamiento Biológico", x = "En Tratamiento Biológico", y = "Eosinófilos (n)") +
  theme(legend.position = "none") +
  stat_compare_means()

cowplot::plot_grid(p1, p2, p3, p4, ncol = 2)
```


## correlacion Feno vs SNOT-22

```{r echo=FALSE, fig.height=8}
p1 <- ggplot(imputed_data, aes(x = snot22, y = feno_mean)) +
  geom_point(size = 3, alpha = 0.7, aes(colour = crs_w_np)) +
  facet_wrap(
    ~ crs_w_np,
    labeller = "label_both"
    ) +
  labs(title = "crs_w_np", x = "SNOT-22", y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_cor(method = "spearman")

p2 <- ggplot(imputed_data, aes(x = snot22, y = feno_mean)) +
  geom_point(size = 3, alpha = 0.7, aes(colour = is_on_biologic)) +
  facet_wrap(
    ~ is_on_biologic,
    labeller = "label_both"
    ) +
  labs(title = "biologic", x = "SNOT-22", y = "FeNO (ppb)") +
  theme(legend.position = "none") +
  stat_cor(method = "spearman")

cowplot::plot_grid(p1, p2, ncol = 1)
```
